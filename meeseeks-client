#!/usr/bin/env python3

import sys
import logging
import json
import time

from meeseeks import Client

def pretty_print(d): print (json.dumps(d, sort_keys=True, indent=4))

def usage():
    print("""
%s [options] <command> [args...]
    commands are:
        submit <pool[@node]> <executable> [args....]
        get [jobid,jobid...] (get all or specified jobs, or set node=|pool=|ts= in options)
        kill <jobid> [,jobid...]
        status (prints all node status)
        pools (prints all pools and free slots)

    options are: 
        address=(default localhost)
        port=(defult 13700)
        refresh=1 (sync interval)
        wait=0|1 (continuously poll status, for submit,get,kill: until no jobs left)
        nodelist= (for submit, list of nodes to prefer)
        restart_on_done=0|1 (for submit, restart on success exit)
        restart_on_fail=0|1 (for submit, restart on fail)
        max_runtime= (for submit, max runtime of job)
"""%sys.argv[0])

#parse args
# cfg={key[.subkey]=value[,value..] args preceeding first non = argument}
# cmd=first non cfg argument
# args=remaining arguments
cfg={
    'address':'localhost',
    'refresh':1,
    'wait':False
    } 
try:
    cmd,args=None,[]
    for i,arg in enumerate(sys.argv[1:]):
        if '=' in arg:
            k,v=arg.split('=',1)
            s=None #sub dict, for k.s=v arguments
            if '.' in k:
                k,sk=k.split('.',1)
                s=cfg.setdefault(k,{})
            if v.isnumeric(): v=int(v)
            elif ',' in v: v=list(v.split(','))
            if s is not None: s[sk]=v
            else: cfg[k]=v
        else: 
            cmd,args=sys.argv[i+1],sys.argv[i+2:] #end of options
            break
    logging.basicConfig(level=cfg.get('log',logging.INFO))
    logging.debug('%s %s %s'%(cfg,cmd,args))
    client=Client(**cfg) #create client and connect
    jids=None
    #get query spec from config if any
    query=dict((k,v) for (k,v) in cfg.items() if k in ['node','pool','ts'])
    #if we will be waiting, wait now until state populated
    if cfg['wait']:
        while not client.get_node_status(): time.sleep(1)
    if cmd == 'submit':
        #get pool, args and optional node selection
        pool,args,node=args[0],args[1:],None
        if '@' in pool: pool,node=pool.split('@',1)
        #if we are waiting on the job, submit locally and let it dispatch
        if cfg['wait']: jids=[client.add_job(pool=pool,args=args,node=node,**cfg)]
        #submit directly and return jid
        else: print(client.submit(pool=pool,args=args,node=node,**cfg))
    elif cmd == 'get':
        if cfg['wait']:
            if args: jids=args
            else: jids=True #get all
        elif args:
            for arg in args: pretty_print({arg:client.query(arg)})
        else: pretty_print(client.query(**query))
    elif cmd == 'kill': 
        for arg in args: pretty_print({arg:client.kill(arg)})
        if cfg['wait'] and args: jids=args
    elif cmd == 'status': 
        if cfg['wait']: 
            while True:
                pretty_print(client.get_node_status())
                time.sleep(cfg['refresh'])
            else: pretty_print(client.status()['nodes'])
    elif cmd == 'pools': 
        if cfg['wait']: 
            while True:
                pretty_print(client.get_pool_status())
                time.sleep(cfg['refresh'])
        else: pretty_print(client.status()['pools'])
    elif cmd == 'ls': pretty_print(client.ls(**cfg))
    else: sys.exit(usage())
    #waiting on jobs
    if jids:
        seq={} #sequence numbers for printing updates
        while True: 
            if jids is True: jobs=client.get(**query)
            else: jobs=dict((jid,client.get_job(jid)) for jid in jids)
            if not any(jobs.values()): break #exit when no jobs left
            #print updates (when job seq != saved seq)
            updates=dict((jid,job) for (jid,job) in jobs.items() if job['seq'] != seq.get(jid))
            if updates: pretty_print(updates)
            seq=dict((jid,job['seq']) for (jid,job) in jobs.items())
            time.sleep(cfg['refresh'])
except Exception as e: print (e,file=sys.stderr)

#if we were polling state, stop gracefully
if cfg['wait']: client.close()